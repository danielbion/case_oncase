---
title: 'Case OnCase'
output: html_notebook
---

Load libraries

```{r, message = FALSE, warning=FALSE}
dir = 'C:/Projects/case_oncase/case_oncase'
setwd(dir)

library(tidyverse)
library(jsonlite)
library(ggthemes)
```


Load the database

```{r, message = FALSE, warning=FALSE}
recipesJson = stream_in(file('receitas.json'))
recipes = as_tibble(recipesJson)
```

Remove outliers/data with missing category or calorie

```{r}
length(which(lengths(recipes$categories) == 0))
length(which(lengths(recipes$directions) == 0))
length(which(lengths(recipes$ingredients) == 0))
length(which(recipes$calories > sd(recipes$calories, na.rm=TRUE) * 3))
length(is.na(recipes$calories))
length(is.na(recipes$protein))
length(is.na(recipes$fat))
length(is.na(recipes$sodium))
length(is.na(recipes$rating))

recipes = recipes %>% 
  filter(lengths(categories) > 0) %>%
  filter(!is.na(calories)) %>%
  filter(calories < sd(calories, na.rm=TRUE) * 3)

```

Estimate a calorie/protein/fat approximation based on the ingredients

TO-DO

Which categories belong to the most caloric foods?

```{r}
rankCalories = recipes %>%
  unnest(categories) %>%
  group_by(categories) %>% 
  summarise(Median = median(calories), Count = n()) %>%
  arrange(desc(Median)) %>%
  filter(Count > 1) %>%
  top_n(20, Median)
rankCalories
  
ggplot(rankCalories, aes(x = reorder(categories, Median), 
  y = Median, fill = Median)) +
  geom_bar(stat='identity') + 
  geom_text(aes(x = categories, y = 100, label = Median), hjust=0, colour = 'white') +
  labs(x = 'Categories') +
  coord_flip() +
  scale_fill_continuous(low="orange", high="red") +
  theme_few()

#goose = recipes %>% filter(str_detect(categories, 'Goose'))


```

What are the top 10 ingredients contained in the most calorie recipes?
```{r}

rankCalories = recipes %>%
  unnest(ingredients) %>%
  group_by(ingredients) %>%
  summarise(Median = median(calories), Count = n()) %>%
  arrange(desc(Median)) %>%
  top_n(10, Median)

rankCalories
```

If you had to recommend 3 recipes based on the data, what would they be?
Depending on the client profile

Healthy
Quer praticidade?
Horário do dia


```{r}
rankRating = recipes %>%
  filter(calories >= median(calories)/1.5 
         & calories <= median(calories) * 1.5
         & sodium < 2000
         & lengths(ingredients) < 5
         & rating >= 4) %>%
  arrange(desc(protein), fat, lengths(directions))
  #top_n(50, Median)

```


