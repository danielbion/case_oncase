---
title: 'Case OnCase'
output: html_notebook
---

Load libraries

```{r, message = FALSE, warning=FALSE}
dir = 'C:/Projects/case_oncase/case_oncase'
setwd(dir)

library(tidyverse)
library(jsonlite)
library(ggthemes)
library(httr)

```


Load the database

```{r, message = FALSE, warning=FALSE}
recipesJson = stream_in(file('receitas.json'))
recipes = as_tibble(recipesJson)
```

Remove outliers/data with missing category or calorie

Extract Date/time 
TO-DO

```{r}
length(which(lengths(recipes$categories) == 0))
length(which(lengths(recipes$directions) == 0))
length(which(lengths(recipes$ingredients) == 0))
length(which(recipes$calories > sd(recipes$calories, na.rm=TRUE) * 3))
length(which(is.na(recipes$calories)))
length(which(is.na(recipes$protein)))
length(which(is.na(recipes$fat)))
length(which(is.na(recipes$sodium)))
length(which(is.na(recipes$rating)))

recipes = recipes[!duplicated(recipes[,c('title', 'desc', 'date')]),]

recipes = recipes %>% 
  filter(lengths(categories) > 0) %>%
  filter(!is.na(calories)) %>%
  filter(calories < sd(calories, na.rm=TRUE) * 3)

```

Binarize the numeric variables
```{r}
createBins = function(var, count){
	breaks = quantile(var, probs = seq(0, 1, 1/count), names = T, na.rm = T)
	cuts = cut(var, breaks=breaks, right = FALSE)
	return (cuts)
}

recipes$caloriesBin = createBins(recipes$calories, 5)
recipes$proteinBin = createBins(recipes$protein, 5)
recipes$fatBin = createBins(recipes$fat, 5)
recipes$sodiumBin = createBins(recipes$sodium, 5)
recipes$ratingBin = createBins(recipes$rating, 3)
recipes$numOfIngredients = lengths(recipes$ingredients)
recipes$numOfDirections = lengths(recipes$directions)

```

Estimate a calorie/protein/fat approximation based on the ingredients

TO-DO

1. Which categories belong to the most caloric foods?

```{r}
rankCalories = recipes %>%
  unnest(categories) %>%
  group_by(categories) %>% 
  summarise(Median = median(calories), Count = n()) %>%
  arrange(desc(Median)) %>%
  filter(Count > 1) %>%
  top_n(20, Median)
rankCalories
  
ggplot(rankCalories, aes(x = reorder(categories, Median), 
  y = Median, fill = Median)) +
  geom_bar(stat='identity') + 
  geom_text(aes(x = categories, y = 100, label = Median), hjust=0, colour = 'white') +
  labs(x = 'Categories') +
  coord_flip() +
  scale_fill_continuous(low="orange", high="red") +
  theme_few()

#goose = recipes %>% filter(str_detect(categories, 'Goose'))


```

2. What are the top 10 ingredients contained in the most calorie recipes?
```{r}

rankCalories = recipes %>%
  unnest(ingredients) %>%
  group_by(ingredients) %>%
  summarise(Median = median(calories), Count = n()) %>%
  arrange(desc(Median)) %>%
  top_n(10, Median)

rankCalories
```

3. If you had to recommend 3 recipes based on the data, what would they be?
Depending on the client profile

Healthy
Quick and easy
Lunch/Breakfast/Dinner



```{r}



rankRating = recipes %>%
  filter(calories >= median(calories)/1.5 
         & calories <= median(calories) * 1.5
         & sodium < 2000
         & protein >= 3
         & lengths(ingredients) < 5
         & rating >= 4.38)
  #top_n(50, Median)

rankRating = rankRating %>% 
  arrange(desc(proteinBin), fatBin, numOfDirections) %>%
  select('title','numOfIngredients', 'numOfDirections', 'proteinBin', 'caloriesBin', 'fatBin')

rankRating[1:3, ]
  
```

4. Does any feature present in the data determine the high grade of a recipe?
Note: I did a review on the site, you can choose between 0 and 4 forks (stars). Was that scaled to 0-5 range?

```{r}
plotCalories = ggplot(recipes, aes(x = rating, y = calories)) +
  geom_bar(stat = "summary", fun.y = "median") 

plotFat = ggplot(recipes, aes(x = rating, y = fat)) +
  geom_bar(stat = "summary", fun.y = "median") 

plotProtein = ggplot(recipes, aes(x = rating, y = protein)) +
  geom_bar(stat = "summary", fun.y = "median") 

plotSodium = ggplot(recipes, aes(x = rating, y = sodium)) +
  geom_bar(stat = "summary", fun.y = "median") 

plotIngredients = ggplot(recipes, aes(x = rating, y = numOfIngredients)) +
  geom_bar(stat = "summary", fun.y = "mean") 

plotDirections = ggplot(recipes, aes(x = rating, y = numOfDirections)) +
  geom_bar(stat = "summary", fun.y = "mean") 

grid.arrange(plotCalories, plotFat, plotProtein, plotSodium, plotIngredients, plotDirections, ncol=3)


```


5. Considering the categories of the top 100 recipes under review, how many recipes are currently on the site https://www.epicurious.com for each category

```{r}

removeAccent = function(str){
  symbols = c(acute = 'áéíóúÁÉÍÓÚıİ', grave = 'àèìòùÀÈÌÒÙ', circunflex = 'âêîôûÂÊÎÔÛ',
      tilde = 'ãõÃÕñÑ', umlaut = 'äëïöüÄËÏÖÜÿ', cedil = 'çÇ')
  
  nudeSymbols = c(acute = 'aeiouAEIOUyY',grave = 'aeiouAEIOU',circunflex = 'aeiouAEIOU',
      tilde = 'aoAOnN',umlaut = 'aeiouAEIOUy',cedil = 'cC')
  
  punct = c(',', '\\.', '\\?', '-', ':', ';', '/')
  for (i in 1:length(punct)){
      str = gsub(punct[i], ' ', str)
  }
  punct = c('\'')
  for (i in 1:length(punct)){
      str = gsub(punct[i], '', str)
  }
  return(chartr(paste(symbols, collapse = ''), paste(nudeSymbols, collapse = ''), str))
}

searchByCategory = function(category){
  category = removeAccent(category)
  category = gsub(' ', '%20', category)
  content = GET(paste0('https://www.epicurious.com/search/', category))
  startIndex = str_locate(content,'<span class="matching-count" data-reactid="39">')[2] + 1
  filteredContent1 = substring(content, startIndex)
  
  endIndex = str_locate(filteredContent1,'</span>')[1] - 1
  text = substring(filteredContent1, 0, endIndex)
  count = as.numeric(gsub(',', '', text))
  return (count)
}

topRecipesByRating = recipes %>%
  arrange(desc(rating))

topRecipesByRating = topRecipesByRating[1:100,]

categories = topRecipesByRating %>%
  select('categories') %>% 
  unnest(categories)

categories = categories[!duplicated(categories),]
#categories$count = sapply(categories$categories, searchByCategory)
#saveRDS(categories, 'categories.rds')
categories <- readRDS('categories.rds')


```



